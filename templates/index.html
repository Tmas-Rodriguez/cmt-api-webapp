<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>CMT - DB manager</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon default.png') }}">
    <style>
        .forbidden {
            pointer-events: none;
            cursor: not-allowed !important;
            opacity: 0.6;
        }
        .disabled-btn {
            pointer-events: none;
            cursor: not-allowed !important;
            opacity: 0.6;
        }
    </style>
</head>
<body>
    <h1>CMT - Data Base Manager</h1>
    <h2>Bucket Refresh</h2>
    <div class="container">
        {% for client in companies %}
        <div class="box {% if client.name == 'ICBC' %}forbidden{% endif %}" 
             id="{{ client.id }}"
             {% if client.name != 'ICBC' %}onclick="selectBox('{{ client.id }}')" {% endif %}>
            {{ client.name }}
        </div>
        {% endfor %}
    </div>

    <div id="sumit-and-result">
        <button class="submit-btn" onclick="startRefreshStream()">Refresh</button>
        <div id="result" class="result-box"></div>
    </div>

    <h2>Validate CSV files</h2>
    <button class="validate-btn" onclick="startGeraStream()">Validate</button>
    <button class="upload-btn disabled-btn" id="uploadBtn" onclick="startUploadStream()" disabled>Upload</button>
    <div id="validate" class="validate-box"></div>

    <script>
        let selectedId = null;

        const colors = {
            "box1": "#c44c4c", // Santander soft red
            "box2": "#343a40", // Grupo Petersen charcoal
            "box3": "#3b5d4c", // Alsea muted dark green
            "box4": "#4361b3", // La Anónima softer blue
            "box5": "#868e96"  // ICBC soft gray
        };

        function selectBox(id) {
            document.querySelectorAll('.box').forEach(b => {
                b.classList.remove('selected');
                b.style.backgroundColor = "";
                b.style.color = "";
            });

            const box = document.getElementById(id);
            box.classList.add('selected');
            box.style.backgroundColor = colors[id];
            box.style.color = "#fff";
            selectedId = id;

            // Save to localStorage
            localStorage.setItem("clientId", id);
        }

        function startGeraStream() {
            const validateBox = document.getElementById("validate");
            validateBox.innerText = "";
            const uploadBtn = document.getElementById("uploadBtn");
            uploadBtn.classList.add("disabled-btn");
            uploadBtn.disabled = true;

            const eventSource = new EventSource("/stream-gera");
            eventSource.onmessage = function(event) {
                const data = event.data;
                console.log("Received event data:", data);
                
                // Check if this is a completion signal
                if (data.includes("'status': 'completed'") || data.includes('"status": "completed"')) {
                    console.log("Completion signal detected!");
                    validateBox.innerText += "\n✓ Validation completed! Starting file download...\n";
                    validateBox.scrollTop = validateBox.scrollHeight;
                    eventSource.close();
                    
                    // Trigger download after a short delay
                    setTimeout(function() {
                        console.log("Triggering download...");
                        downloadGeraFiles();
                    }, 1000);
                    
                    uploadBtn.classList.remove("disabled-btn");
                    uploadBtn.disabled = false;
                } else if (data.includes("'status': 'error'") || data.includes('"status": "error"')) {
                    console.log("Error signal detected!");
                    validateBox.innerText += "\n✗ Validation failed!\n";
                    validateBox.scrollTop = validateBox.scrollHeight;
                    eventSource.close();
                } else {
                    // Regular log line
                    validateBox.innerText += data + "\n";
                    validateBox.scrollTop = validateBox.scrollHeight;

                    // Also enable upload if validation passes
                    if (data.includes("¡Proceso completado exitosamente!")) {
                        uploadBtn.classList.remove("disabled-btn");
                        uploadBtn.disabled = false;
                    }
                }
            };
            eventSource.onerror = function(error) {
                console.error("EventSource error:", error);
                eventSource.close();
            };
        }

        function downloadGeraFiles() {
            console.log("downloadGeraFiles() called");
            const validateBox = document.getElementById("validate");
            validateBox.innerText += "Starting download request...\n";
            validateBox.scrollTop = validateBox.scrollHeight;
            
            fetch("/download-gera-files")
                .then(response => {
                    console.log("Download response status:", response.status);
                    if (!response.ok) {
                        return response.json().then(data => {
                            throw new Error(data.message || "Download failed");
                        });
                    }
                    return response.blob();
                })
                .then(blob => {
                    console.log("Blob received, size:", blob.size);
                    // Create download link
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement("a");
                    a.href = url;
                    a.download = "validation_errors.zip";
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    a.remove();
                    
                    validateBox.innerText += "✓ Files downloaded successfully!\n";
                    validateBox.scrollTop = validateBox.scrollHeight;
                })
                .catch(error => {
                    console.error("Download error:", error);
                    validateBox.innerText += `\n✗ Download error: ${error.message}\n`;
                    validateBox.scrollTop = validateBox.scrollHeight;
                });
        }

        function startUploadStream() {
            const validateBox = document.getElementById("validate");
            validateBox.innerText += "\nStarting upload...\n";
            const eventSource = new EventSource("/stream-upload");
            eventSource.onmessage = function(event) {
                validateBox.innerText += event.data + "\n";
                validateBox.scrollTop = validateBox.scrollHeight;
            };
            eventSource.onerror = function() {
                eventSource.close();
            };
        }

        function startRefreshStream() {
            if (!selectedId) {
                alert("Please select a client first.");
                return;
            }
            else {console.log(selectedId)}
            const refreshBox = document.getElementById("result");
            refreshBox.innerText = "";
            const eventSource = new EventSource("/stream-refresh?selectedId=" + selectedId);
            eventSource.onmessage = function(event) {
                refreshBox.innerText += event.data + "\n";
                // Auto-scroll to bottom
                refreshBox.scrollTop = refreshBox.scrollHeight;
            };
            eventSource.onerror = function() {
                eventSource.close();
            };

        }

    </script>
</body>
</html>
